<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>äººç”Ÿè½‰å½è™•ï½œå¤©è³¦æ•¸å­—äº’å‹•é«”é©—</title>
<style>
body{margin:0;font-family:"Helvetica Neue",sans-serif;background:#f5f6f8;transition:background 0.8s;}
#wrapper{min-height:100vh;display:flex;justify-content:center;align-items:center;}
#app{width:390px;background:#fff;border-radius:26px;padding:26px;box-shadow:0 20px 50px rgba(0,0,0,.18);}
h3{margin-top:0;}
button{width:100%;padding:12px;margin:8px 0;border-radius:14px;border:none;font-size:16px;cursor:pointer;background:#f0f0f0;}
button:hover{background:#e3edff;}
.option{font-size:26px;}
.card{border-radius:22px;padding:22px;color:#fff;box-shadow:0 15px 40px rgba(0,0,0,.25);animation:fadeIn 1s ease;}
.number-section{text-align:center;margin:20px 0;}
.number-card-img{width:100%;max-width:100%;height:auto;display:block;margin:0 auto;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.15);}
.end-section{margin-top:16px;background:linear-gradient(#f6d365,#fda085);border-radius:18px;padding:16px;text-align:center;color:#5a3e00;}
.end-section a{color:#5a3e00;font-weight:bold;text-decoration:underline;}
.qr{width:120px;margin:12px auto;}
.fade{animation:fadeIn 1.4s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
ul{padding-left:18px;}
</style>
</head>

<body>
<div id="wrapper">
  <div id="app"></div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const app = document.getElementById("app");
const body = document.body;

// ğŸ’¡ 1. å®Œå–„çš„ state ç‰©ä»¶çµæ§‹
let state = {
    userName: "æœªçŸ¥ä¾†è³“",
    userPic: "",
    userStatusMessage: "è®€å–ä¸­...",
    deviceInfo: navigator.userAgent, // ä¸€é–‹å§‹å°±æŠ“å–
    mode: "", mood: "", coping: "", desire: "", number: null
};

/* ====== 2. LIFF åˆå§‹åŒ– (åŠ å…¥ async é–å®š) ====== */
async function main() {
    try {
        await liff.init({ liffId: "2008876179-yvn4oUyo" }); 
        
        if (liff.isInClient()) {
            if (!liff.isLoggedIn()) {
                liff.login(); 
                return;
            }
        }

        if (liff.isLoggedIn()) {
            await fetchProfile(); // å‘¼å«å…±ç”¨çš„æŠ“å–å‡½å¼
        } else {
            state.userStatusMessage = "é LINE ç™»å…¥ç’°å¢ƒ";
        }
    } catch (err) {
        console.error("LIFF åˆå§‹åŒ–å¤±æ•—", err);
        state.userStatusMessage = "åˆå§‹åŒ–å‡ºéŒ¯: " + err;
    }
}

// ç¨ç«‹æŠ“å–å‡½å¼ï¼Œæ–¹ä¾¿é‡è¤‡å‘¼å«
async function fetchProfile() {
    try {
        const profile = await liff.getProfile();
        state.userName = profile.displayName;
        state.userPic = profile.pictureUrl || "";
        state.userStatusMessage = profile.statusMessage || "é€™ä½æœ‹å‹å¾ˆä½èª¿ï¼Œæ²’å¯«ç‹€æ…‹å…§å®¹";
    } catch (e) {
        console.error("æŠ“å– Profile å¤±æ•—", e);
    }
}
main(); 

/* ====== 3. æ¸¬é©—é‚è¼¯ (ç¶­æŒä¸è®Š) ====== */
const numberColors = { 1: "linear-gradient(#ff512f,#dd2476)", 2: "linear-gradient(#ff9a44,#ff6a00)", 3: "linear-gradient(#f7971e,#ffd200)", 4: "linear-gradient(#56ab2f,#a8e063)", 5: "linear-gradient(#43cea2,#185a9d)", 6: "linear-gradient(#2193b0,#6dd5ed)", 7: "linear-gradient(#614385,#516395)", 8: "linear-gradient(#8e2de2,#4a00e0)", 9: "linear-gradient(#d66efd,#fbc2eb)" };
const numerology = { 1: { traits: ["ä¸»å‹•", "é ˜å°", "è¡Œå‹•åŠ›", "ç¨ç«‹", "é–‹å‰µ"], tone: "è«‹ç›¸ä¿¡ä½ ä¸æ˜¯è¡å‹•ï¼Œè€Œæ˜¯èµ°åœ¨å‰é¢ã€‚" }, 2: { traits: ["æ•æ„Ÿ", "å”èª¿", "å‚¾è½", "æ”¯æŒ", "é€£çµ"], tone: "ä½ çš„æº«æŸ”ï¼Œæ˜¯ä¸–ç•Œéœ€è¦çš„åŠ›é‡ã€‚" }, 3: { traits: ["è¡¨é”", "å‰µæ„", "å¹½é»˜", "æ„ŸæŸ“åŠ›", "æ¨‚è§€"], tone: "è¢«çœ‹è¦‹çš„ï¼Œæ˜¯ä½ çœŸå¯¦çš„æ¨£å­ã€‚" }, 4: { traits: ["ç©©å®š", "è¸å¯¦", "çµæ§‹", "è€å¿ƒ", "è²¬ä»»"], tone: "æ…¢ä¸€é»ï¼Œä½ åè€Œèµ°å¾—æœ€é ã€‚" }, 5: { traits: ["è‡ªç”±", "è®ŠåŒ–", "å½ˆæ€§", "é«”é©—", "è¡Œå‹•"], tone: "æ”¹è®Šä¸æ˜¯é€ƒé›¢ï¼Œè€Œæ˜¯æˆé•·ã€‚" }, 6: { traits: ["ç…§é¡§", "æ‰¿æ“”", "é—œä¿‚", "è²¬ä»»", "æ„›"], tone: "è«‹è¨˜å¾—ï¼Œä½ ä¹Ÿå€¼å¾—è¢«ç…§é¡§ã€‚" }, 7: { traits: ["æ€è€ƒ", "æ´å¯Ÿ", "å…§çœ", "çœŸå¯¦", "æ·±åº¦"], tone: "å®‰éœï¼Œæ˜¯ä½ æ•´ç†ä¸–ç•Œçš„æ–¹å¼ã€‚" }, 8: { traits: ["åŠ›é‡", "å¯¦è¸", "å½±éŸ¿", "è³‡æº", "æˆå°±"], tone: "ä½ æœ‰èƒ½åŠ›æ‰¿è¼‰æ›´å¤§çš„å±€ã€‚" }, 9: { traits: ["åŒ…å®¹", "å®Œæˆ", "åŒç†", "æ”¾ä¸‹", "æ™ºæ…§"], tone: "æš«åœï¼Œæ˜¯ç‚ºäº†æ–°çš„é–‹å§‹ã€‚" } };

function dynamicMessage(s, n) {
    const m1 = { å·¥ä½œ: "åœ¨å·¥ä½œèˆ‡è²¬ä»»ä¹‹ä¸­ï¼Œ", å®¶åº­: "åœ¨å®¶åº­èˆ‡é—œä¿‚è£¡ï¼Œ", æ±ºç­–: "é¢å°é‡è¦é¸æ“‡æ™‚ï¼Œ", è‡ªæˆ‘: "å›åˆ°ä½ è‡ªå·±èº«ä¸Šï¼Œ" };
    return m1[s.mode] + numerology[n].tone;
}

function lifeNumber(dob) {
    let sum = dob.replaceAll("-", "").split("").reduce((a, b) => a + Number(b), 0);
    while (sum > 9) sum = sum.toString().split("").reduce((a, b) => a + Number(b), 0);
    return sum;
}

/* ====== æµç¨‹èµ·å§‹ ====== */
app.innerHTML = `<h3>å¦‚æœèµ°åˆ°äººç”Ÿä¸€å€‹è½‰å½è™•</h3><p>ç¾åœ¨æœ€æƒ³é—œæ³¨å“ªå€‹é¢å‘ï¼Ÿ</p>
<button onclick="step1('å·¥ä½œ')">ğŸ§³ å·¥ä½œ / äº‹æ¥­</button><button onclick="step1('å®¶åº­')">ğŸ  å®¶åº­ / é—œä¿‚</button>
<button onclick="step1('æ±ºç­–')">ğŸ§­ é‡å¤§æ±ºç­–</button><button onclick="step1('è‡ªæˆ‘')">ğŸŒ± è‡ªæˆ‘ç‹€æ…‹</button>`;

function step1(v) { state.mode = v; app.innerHTML = `<h3>æ­¤åˆ»çš„å…§åœ¨é¢¨æ™¯ï¼Ÿ</h3>
<button class="option" onclick="step2('éœ§')">ğŸŒ«ï¸</button><button class="option" onclick="step2('å…‰')">ğŸŒ…</button>
<button class="option" onclick="step2('å¤œ')">ğŸŒŒ</button><button class="option" onclick="step2('é¢¨')">ğŸŒ¬ï¸</button>`; }

function step2(v) { state.mood = v; app.innerHTML = `<h3>é¢å°é€™æ¨£çš„ç‹€æ…‹...</h3>
<button onclick="step3('æ’è‘—ä¸èªª')">ğŸ’ª æ’è‘—ä¸èªª</button><button onclick="step3('éœä¸‹æ²‰æ¾±')">ğŸ§˜ éœä¸‹æ²‰æ¾±</button>
<button onclick="step3('æ‰¾äººèŠèŠ')">ğŸ’¬ æ‰¾äººèŠèŠ</button><button onclick="step3('è½‰ç§»æ³¨æ„')">ğŸ§ è½‰ç§»æ³¨æ„</button>`; }

function step3(v) { state.coping = v; app.innerHTML = `<h3>ä½ æ›´æ¸´æœ›å“ªä¸€ç¨®ï¼Ÿ</h3>
<button onclick="step4('ç©©å®š')">ğŸ”¥ ç©©å®š</button><button onclick="step4('çªç ´')">ğŸš€ çªç ´</button>
<button onclick="step4('å¹³è¡¡')">âš–ï¸ å¹³è¡¡</button><button onclick="step4('æ”¾ä¸‹')">ğŸƒ æ”¾ä¸‹</button>`; }

function step4(v) { state.desire = v; app.innerHTML = `<h3>è«‹è¼¸å…¥ä½ çš„è¥¿å…ƒå‡ºç”Ÿå¹´æœˆæ—¥</h3>
<input id="dob" type="date" style="width:100%;padding:10px;border-radius:12px;">
<button onclick="showResult()">ğŸ”® æƒ³çœ‹çœ‹å¦‚ä½•å‰é€² ğŸ§­</button>`; }

async function showResult() {
    const dob = document.getElementById("dob").value;
    if (!dob) { alert("è«‹è¼¸å…¥æ—¥æœŸ"); return; }
    
    // ğŸ’¡ é—œéµä¿éšªï¼šå¦‚æœé€™æ™‚å€™åå­—é‚„æ˜¯ã€ŒæœªçŸ¥ä¾†è³“ã€ï¼Œå¼·åˆ¶å†æŠ“ä¸€æ¬¡
    if (liff.isLoggedIn() && state.userName === "æœªçŸ¥ä¾†è³“") {
        await fetchProfile();
    }

    state.number = lifeNumber(dob);
    const n = state.number;
    body.style.background = numberColors[n];
    const traits = numerology[n].traits.join("ã€"); 
    const blessing = dynamicMessage(state, n); 

    app.innerHTML = `
  <div class="card" style="background:${numberColors[n]}">
    <h3 class="fade">ä½ çš„å°ˆå±¬å¤©è³¦æ•¸å­—æ˜¯ ${n}</h3>
    <ul class="fade">${numerology[n].traits.map(t => `<li>${t}</li>`).join("")}</ul>
    <p class="fade">${blessing}</p>
  </div>
  <div class="number-section fade"><img src="N0${n}C.png" class="number-card-img"></div>
  <div class="end-section fade"><p>èˆ‡ Betterï¼ˆé‡ç¾©ï¼‰è¯çµ¡ï¼š</p>
    <a href="https://better885.pse.is/Line2BetterHung" target="_blank">é»æ­¤è¯çµ¡</a><br>
    <img src="BetterQRCode.jpg" class="qr"><br><br>
    <small>2026/01/15 Ver 2.6.5 (å¼·æ•ˆé–å®šç‰ˆ)</small>
  </div>`;

    sendToBackstage(dob, n, traits, blessing);
}

async function sendToBackstage(dob, n, traits, blessing) {
    const gasUrl = "https://script.google.com/macros/s/AKfycbw9IbWl6aCYYzF8x4T6ttW5NlKpvPQEvFmE8DgRhf7ya43r9PJSwmSZk7KwMrVySGL9/exec";
    const fullReport = `ğŸŒŸ ã€å¤©è³¦æ•¸å­—æ¢ç´¢å ±å‘Šã€‘ ğŸŒŸ\nğŸ‘¤ æœ‹å‹å§“åï¼š${state.userName}\nğŸ”® æœ‹å‹ç‹€æ…‹ï¼š${state.userStatusMessage}\nğŸ“… æœ‹å‹ç”Ÿæ—¥ï¼š${dob}\nğŸ”¢ å¤©è³¦æ•¸å­—ï¼š${n} è™Ÿäºº\nâœ¨ ç‰¹è³ªæ¨™ç±¤ï¼š${traits}\nğŸ“± è£ç½®è¨­å‚™ï¼š${state.deviceInfo}\nğŸ–¼ï¸ é ­åƒç¶²å€ï¼š${state.userPic}\nâœ‰ï¸ ç¥ç¦ï¼š${blessing}`.trim();

    fetch(gasUrl, { method: "POST", body: JSON.stringify({ result: fullReport }), mode: 'no-cors' });
}
</script>
</body>
</html>