<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>äººç”Ÿè½‰å½è™•ï½œå¤©è³¦æ•¸å­—äº’å‹•é«”é©—</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
body{
  margin:0;
  font-family:"Helvetica Neue", sans-serif;
  background:#f5f6f8;
  transition:background 0.8s;
}
#wrapper{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}


#app {
  /* 1. å¯¬åº¦å¤§æ°£åŒ–ï¼šç­†é›»èˆ‡å¹³æ¿è¢å¹•å¤§ï¼Œå¯¬åº¦æ”¾é–‹åˆ° 800pxï¼Œåˆ©ç”¨ç‡ç«‹åˆ»æå‡ */
 /* width: 95%; */
  width: calc(100% - 40px);
  max-width: 800px; 
  
  /* 2. æ¸›å°‘æ»‘å‹•ï¼šå°‡é«˜åº¦é™åˆ¶æ”¾å¯¬åˆ° 98vhï¼Œå¹¾ä¹è²¼è¿‘è¢å¹•é‚Šç·£ï¼Œç¢ºä¿ä¸€ç•«é¢å‘ˆç¾å®Œ */
  max-height: 98vh; 
  
  overflow-y: auto;
  background: #fff;
  border-radius: 26px;
  
  /* 3. è§£æ±ºå£“æ¡†èˆ‡ç½®ä¸­ */
  padding: 40px; 
  text-align: center; 
  
  box-shadow: 0 20px 50px rgba(0,0,0,.18);
  box-sizing: border-box; 
  margin: 10px auto; /* æ¸›å°‘ marginï¼Œçˆ­å–æ›´å¤šå‚ç›´ç©ºé–“ */
}


/* 2. åœ¨æ‰‹æ©Ÿç‰ˆé©åº¦æ”¾é–‹å¯¬åº¦ï¼Œè§£æ±ºå£“æ¡† */
@media screen and (max-width: 480px) {
 #app {
       padding: 24px; /* æ‰‹æ©Ÿç‰ˆä¸éœ€è¦ 40px é‚£éº¼å¤§ï¼Œ24px å°±èƒ½ä¿è­‰ä¸å£“æ¡†ä¸”ç•™å‡ºç©ºé–“ */
      }
      }


/* 4. é‡å°ç­†é›»/å¹³æ¿çš„å¤§è¢å¹•å„ªåŒ–ï¼šè®“ 2x2 çŸ©é™£æ›´å¯¬ï¼Œè¦–è¦ºæ›´é–‹é—Š */
@media screen and (min-width: 768px) {
  .options-container {
    gap: 20px; /* å¢åŠ æŒ‰éˆ•é–“è·ï¼Œå¤§è¢å¹•çœ‹èµ·ä¾†æ›´å°ˆæ¥­ */
  }
  button {
    padding: 24px 10px; /* å¢åŠ æŒ‰éˆ•é«˜åº¦ï¼Œè®“å¤§è¢å¹•ä¸å†å°å®¶å­æ°£ */
  }
}




/* ğŸ’¡ é¸é …æŒ‰éˆ•å®¹å™¨ï¼šæ”¹ç‚º 2x2 çŸ©é™£æ’åˆ— */
.options-container {
  display: grid;
  grid-template-columns: 1fr 1fr; /* å…©æ¬„å¹³åˆ† */
  gap: 12px;                      /* æŒ‰éˆ•é–“è· */
  margin-top: 20px;
}

button {
  width: 100%;
  padding: 16px 8px;              /* å¢åŠ é«˜åº¦ */
  border-radius: 16px;
  border: none;
  background: #f8f9fa;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  flex-direction: column;
  align-items: center;
}

// h3 {
//  margin-top: 0;
//  font-size: 1.4rem;   /* çµ±ä¸€æ¨™é¡Œå­—ç´š */
//  color: #333;
//  margin-bottom: 15px;
// }

/* 4. å„ªåŒ–æ¨™é¡Œèˆ‡æ®µè½çš„è¡Œé«˜ï¼Œé˜²æ­¢æ–‡å­—æ“æ“  */
h3 {
  margin-top: 0;
  color: #333;
  line-height: 1.5; /* å¢åŠ è¡Œè·ï¼Œè¦–è¦ºæ›´èˆ’å±• */
  margin-bottom: 20px;
  word-break: keep-all;
}



button:hover{background:#e3edff;}
// .option{font-size:26px;}
/* ğŸ’¡ æ”¾å¤§è¡¨æƒ…è²¼ï¼šè®“æƒ…ç·’å¼µåŠ›è®Šå¼· */
.option {
  font-size: 48px !important;    /* è®“è¡¨æƒ…è²¼çœ‹èµ·ä¾†åƒåœ–æª”ä¸€æ¨£å¤§ */
  margin-bottom: 8px;
  display: block;
}


// .small{font-size:13px;color:#666;}
.small {
  font-size: 14px;
  color: #555;
  font-weight: bold;
}



/* ğŸ’¡ é‡å°çµæœé ç¬¬ä¸€æ®µæ¨™é¡Œæ–‡å­—èª¿å¤§ï¼Œå¢åŠ å­˜åœ¨æ„Ÿ */
// .fade h3 {
//  font-size: 1.5rem;   /* å†å¤§ä¸€é»ï¼Œæ›´æœ‰éœ‡æ’¼åŠ› */
//  line-height: 1.4;
//  margin-bottom: 12px;
//  color: #333;
// }

/* ğŸ’¡ é‡å°çµæœé ç¬¬ä¸€æ®µæ¨™é¡Œæ–‡å­—èª¿å¤§ï¼Œå¢åŠ å­˜åœ¨æ„Ÿ */
/* ğŸ’¡ è§£æ±ºçµæœé æ¨™é¡Œå£“æ¡† */
.fade h3 {
  font-size: 1.5rem; /* å†å¤§ä¸€é»ï¼Œæ›´æœ‰éœ‡æ’¼åŠ› */
  line-height: 1.4;
  margin: 0 0 15px 0;
  color: #333;
  padding: 0 5px;                /* çµ¦æ–‡å­—ä¸€é»å…§ç¸®å‘¼å¸ */
}

p {
  line-height: 1.6;
  color: #555;
}


.card {
  width: 100%;
  max-width: 100%;
  height: auto;
  border-radius: 18px;
//  display: block;
  box-shadow: 0 15px 40px rgba(0,0,0,.25);
// box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  animation: fadeIn 1s ease;
  margin: 15px 0;
}





.fade{animation:fadeIn 1.4s ease;}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px);}
  to{opacity:1;transform:translateY(0);}
}

.number-section {
  text-align: center;
  margin: 20px 0;
}
.number-card-img {
  width: 100%;
  max-width: 100%; 
  height: auto;
  display: block;
  margin: 0 auto;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

// .end-section{
//  margin-top:16px;
//  background:linear-gradient(#f6d365,#fda085);
//  border-radius:18px;
//  padding:16px;
//  text-align:center;
//  color:#5a3e00;
// }

/* 1. ç¢ºä¿çµæœé åº•éƒ¨å®Œå…¨ç½®ä¸­ï¼Œè§£æ±º QRCode æ­ªæ–œ */
.end-section {
  margin-top: 16px;
  background: linear-gradient(#f6d365, #fda085);
  border-radius: 18px;
  padding: 20px;
  display: block; 
  text-align: center; /* ç¢ºä¿é€™è£¡ä¹Ÿæœ‰ç½®ä¸­ */
  color: #5a3e00;
}

/* 2. åœ¨æ‰‹æ©Ÿç‰ˆé©åº¦æ”¾é–‹å¯¬åº¦ï¼Œè§£æ±ºå£“æ¡† */
//@media screen and (max-width: 480px) {
//  #app {
//    padding: 24px; /* æ‰‹æ©Ÿç‰ˆä¸éœ€è¦ 40px é‚£éº¼å¤§ï¼Œ24px å°±èƒ½ä¿è­‰ä¸å£“æ¡†ä¸”ç•™å‡ºç©ºé–“ */
//  }
// }


.end-section a{
  color:#5a3e00;
  font-weight:bold;
  text-decoration:underline;
}
.qr{
  width:120px;
  margin:12px auto;
}
ul{padding-left:18px;}
</style>
</head>

<body>
<div id="wrapper">
  <div id="app"></div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const app = document.getElementById("app");
const body = document.body;

// ğŸ’¡ a. å°‡é è¨­å€¼è¨­ç‚ºæ˜ç¢ºçš„æ¨™è¨˜
let state = {
    userName: "å°šæœªç™»å…¥",
    userStatus: "ç‹€æ…‹è¼‰å…¥ä¸­",
    userPic: "",
    from: "æœªçŸ¥ä¾†æº", // ğŸ’¡ æ–°å¢é€™è¡Œï¼Œé è¨­å€¼
    deviceInfo: navigator.userAgent
};


/* ====== 1. çµ±ä¸€æŠ“å–è³‡æ–™çš„å‡½å¼ (æ–°å¢,ç¢ºä¿æœ€æ–°ç‹€æ…‹) ====== */
async function fetchUserProfile() {
    try {
        if (liff.isLoggedIn()) {
            const profile = await liff.getProfile();
            state.userName = profile.displayName;
            state.userStatus = profile.statusMessage || "ğŸŒ¿";
            state.userPic = profile.pictureUrl;

// ğŸ’¡ ç²å–ç’°å¢ƒè³‡è¨Š (å¼·åŒ–ç‰ˆ)
            const context = liff.getContext();
            console.log("Context Type:", context ? context.type : "No Context"); // æ¸¬è©¦ç”¨

            if (context && context.type) {
                const typeMap = {
                    'utou': 'å€‹äººç§è¨Š',
                    'group': 'ç¾¤çµ„',
                    'room': 'èŠå¤©å®¤',
                    'none': 'å¤–éƒ¨ç€è¦½å™¨'
                };
                state.from = typeMap[context.type] || `å…¶ä»–(${context.type})`;
            } else {
                // å¦‚æœé€£ context ç‰©ä»¶éƒ½æ²’æœ‰ï¼Œé€šå¸¸ä»£è¡¨æ˜¯åœ¨å®Œå…¨è„«é›¢ LINE çš„ç’°å¢ƒä¸‹é–‹å•Ÿ
                state.from = "å¤–éƒ¨ç€è¦½å™¨(éLIFFç’°å¢ƒ)";
            }
            const urlParams = new URLSearchParams(window.location.search);
            const customSource = urlParams.get('for');
            if (customSource) {
               state.from += ` (${customSource})`;
               }
            return true;
        }
    } catch (e) {
        console.error("æŠ“å– Profile å¤±æ•—", e); }
    return false; // æŠ“å–å¤±æ•—
}


/* ====== 2. LIFF åˆå§‹åŒ–ä¿®æ­£ ====== */
/* ====== 2. main å‡½å¼ä¿®æ­£ï¼šæ‰‹å‹•é‚„åŸï¼Œé˜²æ­¢æ ¼å¼éŒ¯èª¤ ====== */
async function main() {
    try {
        await liff.init({ liffId: "2008876179-yvn4oUyo" });
        if (liff.isLoggedIn()) {
            await fetchUserProfile();
            
            const saved = localStorage.getItem("pendingResult");
            if (saved) {
                const data = JSON.parse(saved);
                
                // ğŸ’¡ æ‰‹å‹•ç²¾ç¢ºé‚„åŸï¼Œä¸ä½¿ç”¨ Object.assign ä»¥å…å¸¶å…¥é«’è³‡æ–™
                state.mode = data.mode;
                state.mood = data.mood;
                state.coping = data.coping;
                state.desire = data.desire;
                
                // æ‹¿å®Œå°±ç«‹åˆ»æ¸…ç©ºç­†è¨˜æœ¬
                localStorage.removeItem("pendingResult");

                // ğŸ’¡ é—œéµï¼šæˆ‘å€‘ç›´æ¥æ‰‹å‹•å‘¼å«è¨ˆç®—é‚è¼¯ï¼Œä¸è¦ç¶“é showResult çš„ã€Œç”Ÿæ—¥æª¢æŸ¥ã€
                // å› ç‚ºè³‡æ–™å·²ç¶“åœ¨ç­†è¨˜æœ¬è£¡äº†
                completeProcessFromStorage(data.dob); 
            } else {
                startApp();
            }
        }
    } catch (err) { console.error(err); }
}

main();

// ğŸ’¡ æ–°å¢ä¸€å€‹å°åŠ©æ‰‹ï¼Œå°ˆé–€è™•ç†ã€Œå¾è¨˜æ†¶ä¸­æ¢å¾©ã€çš„é¡¯ç¤º
function completeProcessFromStorage(dobValue) {
    // å»ºç«‹ä¸€å€‹è‡¨æ™‚çš„è™›æ“¬è¼¸å…¥æ¡†ï¼Œå¥½è®“åŸæœ¬çš„ showResult èƒ½æŠ“åˆ°ç”Ÿæ—¥
    app.innerHTML = `<input id="dob" type="hidden" value="${dobValue}">`;
    showResult(); 
}

/* ====== å½©è™¹è‰²å°ç…§ ====== */
const numberColors = {
    1: "linear-gradient(#ff512f,#dd2476)",
    2: "linear-gradient(#ff9a44,#ff6a00)",
    3: "linear-gradient(#f7971e,#ffd200)",
    4: "linear-gradient(#56ab2f,#a8e063)",
    5: "linear-gradient(#43cea2,#185a9d)",
    6: "linear-gradient(#2193b0,#6dd5ed)",
    7: "linear-gradient(#614385,#516395)",
    8: "linear-gradient(#8e2de2,#4a00e0)",
    9: "linear-gradient(#d66efd,#fbc2eb)"
};

/* ====== ç”Ÿå‘½éˆæ•¸è³‡æ–™ ====== */
const numerology = {
    1: { traits: ["ä¸»å‹•", "é ˜å°", "è¡Œå‹•åŠ›", "ç¨ç«‹", "é–‹å‰µ"], tone: "è«‹ç›¸ä¿¡ä½ ä¸æ˜¯è¡å‹•ï¼Œè€Œæ˜¯èµ°åœ¨å‰é¢ã€‚" },
    2: { traits: ["æ•æ„Ÿ", "å”èª¿", "å‚¾è½", "æ”¯æŒ", "é€£çµ"], tone: "ä½ çš„æº«æŸ”ï¼Œæ˜¯ä¸–ç•Œéœ€è¦çš„åŠ›é‡ã€‚" },
    3: { traits: ["è¡¨é”", "å‰µæ„", "å¹½é»˜", "æ„ŸæŸ“åŠ›", "æ¨‚è§€"], tone: "è¢«çœ‹è¦‹çš„ï¼Œæ˜¯ä½ çœŸå¯¦çš„æ¨£å­ã€‚" },
    4: { traits: ["ç©©å®š", "è¸å¯¦", "çµæ§‹", "è€å¿ƒ", "è²¬ä»»"], tone: "æ…¢ä¸€é»ï¼Œä½ åè€Œèµ°å¾—æœ€é ã€‚" },
    5: { traits: ["è‡ªç”±", "è®ŠåŒ–", "å½ˆæ€§", "é«”é©—", "è¡Œå‹•"], tone: "æ”¹è®Šä¸æ˜¯é€ƒé›¢ï¼Œè€Œæ˜¯æˆé•·ã€‚" },
    6: { traits: ["ç…§é¡§", "æ‰¿æ“”", "é—œä¿‚", "è²¬ä»»", "æ„›"], tone: "è«‹è¨˜å¾—ï¼Œä½ ä¹Ÿå€¼å¾—è¢«ç…§é¡§ã€‚" },
    7: { traits: ["æ€è€ƒ", "æ´å¯Ÿ", "å…§çœ", "çœŸå¯¦", "æ·±åº¦"], tone: "å®‰éœï¼Œæ˜¯ä½ æ•´ç†ä¸–ç•Œçš„æ–¹å¼ã€‚" },
    8: { traits: ["åŠ›é‡", "å¯¦è¸", "å½±éŸ¿", "è³‡æº", "æˆå°±"], tone: "ä½ æœ‰èƒ½åŠ›æ‰¿è¼‰æ›´å¤§çš„å±€ã€‚" },
    9: { traits: ["åŒ…å®¹", "å®Œæˆ", "åŒç†", "æ”¾ä¸‹", "æ™ºæ…§"], tone: "æš«åœï¼Œæ˜¯ç‚ºäº†æ–°çš„é–‹å§‹ã€‚" }
};

function dynamicMessage(s, n) {
    const m1 = { å·¥ä½œ: "åœ¨å·¥ä½œèˆ‡è²¬ä»»ä¹‹ä¸­ï¼Œ", å®¶åº­: "åœ¨å®¶åº­èˆ‡é—œä¿‚è£¡ï¼Œ", æ±ºç­–: "é¢å°é‡è¦é¸æ“‡æ™‚ï¼Œ", è‡ªæˆ‘: "å›åˆ°ä½ è‡ªå·±èº«ä¸Šï¼Œ" };
    const m2 = { éœ§: "ä½ å…¶å¯¦å·²ç¶“æ„Ÿè¦ºåˆ°è¿·æƒ˜ï¼Œ", å…‰: "ä½ å·²ç¶“çœ‹è¦‹ä¸€æ¢å¯èƒ½çš„è·¯ï¼Œ", å¤œ: "ä½ æ­£åœ¨ä½èª¿ç´¯ç©åŠ›é‡ï¼Œ", é¢¨: "ä½ æ¸´æœ›æ”¹è®Šç¾ç‹€ï¼Œ" };
    const m3 = { æ’è‘—ä¸èªª: "ä½†ä½ é¸æ“‡å…ˆæ’ä½ä¸èªªï¼Œ", éœä¸‹æ²‰æ¾±: "ä½ è®“è‡ªå·±æ…¢æ…¢æ²‰æ¾±ï¼Œ", æ‰¾äººèŠèŠ: "ä½ é¡˜æ„å°‹æ±‚é€£çµï¼Œ", è½‰ç§»æ³¨æ„: "ä½ æš«æ™‚ä¸æƒ³æ­£é¢é¢å°ï¼Œ" };
    const m4 = { ç©©å®š: "å› ç‚ºä½ éœ€è¦å®‰å…¨æ„Ÿã€‚", çªç ´: "å› ç‚ºä½ ä¸æƒ³å†åŸåœ°æ‰“è½‰ã€‚", å¹³è¡¡: "å› ç‚ºä½ æƒ³æ‰¾å›å…§åœ¨ç§©åºã€‚", æ”¾ä¸‹: "å› ç‚ºä½ çœŸçš„èƒŒå¤ªå¤šäº†ã€‚" };
    return m1[s.mode] + m2[s.mood] + m3[s.coping] + m4[s.desire] + " " + numerology[n].tone;
}

function lifeNumber(dob) {
    let sum = dob.replaceAll("-", "").split("").reduce((a, b) => a + Number(b), 0);
    while (sum > 9) sum = sum.toString().split("").reduce((a, b) => a + Number(b), 0);
    return sum;
}


// ğŸ’¡ 1. åˆå§‹ç•«é¢ (è«‹æ‰¾åˆ°é€™ä¸€å€å¡Šè¦†è“‹)
app.innerHTML = `
<div class="fade">
  <h3>å¦‚æœèµ°åˆ°äººç”Ÿä¸€å€‹è½‰å½è™•</h3>
  <p>ç¾åœ¨æœ€æƒ³é—œæ³¨å“ªå€‹é¢å‘ï¼Ÿ</p>
  <div class="options-container">
    <button onclick="step1('å·¥ä½œ')"><span class="small">ğŸ§³ å·¥ä½œ / äº‹æ¥­</span></button>
    <button onclick="step1('å®¶åº­')"><span class="small">ğŸ  å®¶åº­ / é—œä¿‚</span></button>
    <button onclick="step1('æ±ºç­–')"><span class="small">ğŸ§­ é‡å¤§æ±ºç­–</span></button>
    <button onclick="step1('è‡ªæˆ‘')"><span class="small">ğŸŒ± è‡ªæˆ‘ç‹€æ…‹</span></button>
  </div>
</div>
`;

// ğŸ’¡ 2. step1 å‡½å¼
function step1(v) { 
  state.mode = v; 
  app.innerHTML = `
  <div class="fade">
    <h3>æ­¤åˆ»çš„å…§åœ¨é¢¨æ™¯åƒå“ªä¸€å¹…ï¼Ÿ</h3>
    <div class="options-container">
      <button onclick="step2('éœ§')"><span class="option">ğŸŒ«ï¸</span><span class="small">è¿·éœ§</span></button>
      <button onclick="step2('å…‰')"><span class="option">ğŸŒ…</span><span class="small">æ™¨æ›¦</span></button>
      <button onclick="step2('å¤œ')"><span class="option">ğŸŒŒ</span><span class="small">æ˜Ÿå¤œ</span></button>
      <button onclick="step2('é¢¨')"><span class="option">ğŸŒ¬ï¸</span><span class="small">å¾®é¢¨</span></button>
    </div>
  </div>`; 
}


// ğŸ’¡ 3. step2 å‡½å¼
function step2(v) { 
  state.mood = v; 
  app.innerHTML = `
  <div class="fade">
    <h3>é¢å°é€™æ¨£çš„ç‹€æ…‹</h3>
    <div class="options-container">
      <button onclick="step3('æ’è‘—ä¸èªª')"><span class="option">ğŸ’ªğŸ˜‘</span><span class="small">æ’è‘—ä¸èªª</span></button>
      <button onclick="step3('éœä¸‹æ²‰æ¾±')"><span class="option">ğŸ§˜â€â™€ï¸</span><span class="small">éœä¸‹æ²‰æ¾±</span></button>
      <button onclick="step3('æ‰¾äººèŠèŠ')"><span class="option">ğŸ’¬ğŸ‘¥</span><span class="small">æ‰¾äººèŠèŠ</span></button>
      <button onclick="step3('è½‰ç§»æ³¨æ„')"><span class="option">ğŸ§ğŸ¤¹</span><span class="small">è½‰ç§»æ³¨æ„</span></button>
    </div>
  </div>`; 
}


// ğŸ’¡ 4. step3 å‡½å¼
function step3(v) { 
  state.coping = v; 
  app.innerHTML = `
  <div class="fade">
    <h3>ä½ æ›´æ¸´æœ›å“ªä¸€ç¨®ï¼Ÿ</h3>
    <div class="options-container">
      <button onclick="step4('ç©©å®š')"><span class="option">ğŸ”¥</span><span class="small">ç©©å®š</span></button>
      <button onclick="step4('çªç ´')"><span class="option">ğŸš€</span><span class="small">çªç ´</span></button>
      <button onclick="step4('å¹³è¡¡')"><span class="option">âš–ï¸</span><span class="small">å¹³è¡¡</span></button>
      <button onclick="step4('æ”¾ä¸‹')"><span class="option">ğŸƒ</span><span class="small">æ”¾ä¸‹</span></button>
    </div>
  </div>`; 
}

function step4(v) { state.desire = v; app.innerHTML = `
<h3>è«‹è¼¸å…¥ä½ çš„è¥¿å…ƒå‡ºç”Ÿå¹´æœˆæ—¥</h3>
<input id="dob" type="date" style="width:100%;padding:10px;border-radius:12px;">
<button onclick="showResult()">ğŸ”®æƒ³çœ‹çœ‹å¦‚ä½•å‰é€²ğŸ§­</button>`; }


/* ====== 3. showResult æ ¸å¿ƒä¿®æ­£ (è«‹ç¢ºä¿æ‹¬å¼§æˆå°) ====== */
async function showResult() {
    const dob = document.getElementById("dob").value;
    if (!dob) { alert("è«‹è¼¸å…¥æ—¥æœŸ"); return; }

    // ã€ç¬¬ä¸€é“é–ã€‘æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    if (!liff.isLoggedIn()) {
        liff.login();
        return; 
    }

    // ã€ç¬¬äºŒé“é–ã€‘å³ä½¿ç™»å…¥ï¼Œè‹¥ state é‚„æ˜¯é è¨­å€¼ï¼Œç¾å ´é‡æŠ“ä¸€æ¬¡
    if (state.userName === "å°šæœªç™»å…¥") {
        await fetchUserProfile();
    }

    // å¦‚æœç¾å ´é‡æŠ“é‚„æ˜¯å¤±æ•—ï¼Œæ‰åŸ·è¡Œ 5 æ¬¡é‡è©¦è¿´åœˆ
    let retryCount = 0;
    while (state.userName === "å°šæœªç™»å…¥" && retryCount < 5) {
        await fetchUserProfile(); 
        if (state.userName === "å°šæœªç™»å…¥") {
            await new Promise(res => setTimeout(res, 400));
            retryCount++;
        }
    }

    // ã€ç¬¬ä¸‰é“é–ã€‘æœ€çµ‚ä¿éšªï¼šè‹¥çœŸçš„å¾¹åº•æŠ“ä¸åˆ°ï¼Œæ‰å«ä»–é‡ç™»
    // ã€ç¬¬å››é“é–ã€‘çµ‚æ¥µä¿éšª
    if (state.userName === "å°šæœªç™»å…¥") {
        // ğŸ’¡ å‹•ä½œ 1ï¼šæŠŠç›®å‰æ¸¬é©—çµæœå­˜èµ·ä¾†
        const saveSession = {
            mode: state.mode,
            mood: state.mood,
            coping: state.coping,
            desire: state.desire,
            dob: dob // å‰›è¼¸å…¥çš„ç”Ÿæ—¥
        };
        localStorage.setItem("pendingResult", JSON.stringify(saveSession));

        alert("éœ€ç™»å…¥ä»¥ç”¢å‡ºå°æ‚¨çš„å›é¥‹ğŸ“éº»ç…©æ‚¨å›‰ğŸ™‚è¬è¬ï¼ğŸ™ğŸ½");
        liff.logout(); 
        liff.login(); 
        return; 
    }

    state.number = lifeNumber(dob);
    const n = state.number;
    const color = numberColors[n];
    body.style.background = color;

    const traits = numerology[n].traits.join("ã€"); 
    const blessing = dynamicMessage(state, n); 
    const fileName = `N0${n}C.png`;

    app.innerHTML = `
  <div class="card" style="background:${color}">
    <h3 class="fade">ä½ çš„å°ˆå±¬å¤©è³¦æ•¸å­—æ˜¯ ${n}</h3>
    <ul class="fade">${numerology[n].traits.map(t => `<li>${t}</li>`).join("")}</ul>
    <p class="fade">${blessing}</p>
  </div>

  <div class="number-section fade">
    <img src="${fileName}" class="number-card-img" alt="å¤©è³¦æ•¸å­—åœ–å¡">
  </div>

  <div class="end-section fade">
    <p>æœŸå¾…æœ‰æ©ŸæœƒèŠèŠï¼Œ<br>
    é»æ“Šé€£çµæˆ–æƒæ QRCode<br>
    å³å¯èˆ‡ Betterï¼ˆé‡ç¾©ï¼‰è¯çµ¡ï¼š</p>
  </div>

// è«‹å°‡æ‚¨çš„ä»£ç¢¼æ”¹ç‚ºé€™æ¨£ï¼š
<div style="text-align: center;">
  <a href="https://better885.pse.is/Line2BetterHung" target="_blank">
    https://better885.pse.is/Line2BetterHung
  </a>
</div>

<div style="text-align: center;">
  <a href="https://better885.pse.is/Line2BetterHung" target="_blank">
    <img src="BetterQRCode.jpg" class="qr">
  </a>
</div>




<br>
    å¦‚æœæœ‰è¢«å°å°Touchåˆ°ï¼Œæ­¡è¿åˆ†äº«çµ¦ğŸ‘«æœ€å¥½çš„æœ‹å‹ğŸ’Œ<br>
<br>
<br>
    ä¹ŸæœŸå¾…æ‚¨èˆ‡æˆ‘åˆ†äº«æ‚¨çš„åœ–å¡ğŸ´<br>
<br>
    2025/01/17 PM 07:00 Ver 3.1.8<br>
  </div>
  `;

    sendToBackstage(dob, n, traits, blessing);
}

async function sendToBackstage(dob, n, traits, blessing) {
    const gasUrl = "https://script.google.com/macros/s/AKfycbw9IbWl6aCYYzF8x4T6ttW5NlKpvPQEvFmE8DgRhf7ya43r9PJSwmSZk7KwMrVySGL9/exec";

    const fullReport = `
ğŸŒŸ ã€å¤©è³¦æ•¸å­—æ¢ç´¢å ±å‘Šã€‘ ğŸŒŸ
---------------------------
ğŸ‘¤ æœ‹å‹å§“åï¼š${state.userName}
ğŸ¤¹â€ æœ‹å‹ç‹€æ…‹ï¼š${state.userStatus}
ğŸ§­ ç©å®¶ä½ç½®ï¼š${state.from} 
ğŸ“… æœ‹å‹ç”Ÿæ—¥ï¼š${dob}
ğŸ”¢ å¤©è³¦æ•¸å­—ï¼š${n} è™Ÿäºº
âœ¨ ç‰¹è³ªæ¨™ç±¤ï¼š${traits}
ğŸ“± è£ç½®è¨­å‚™ï¼š${state.deviceInfo}
ğŸ–¼ï¸ é ­åƒç¶²å€ï¼š${state.userPic}
---------------------------
ğŸ§  æ¢ç´¢è»Œè·¡ï¼š
1. é—œæ³¨é¢å‘ï¼š${state.mode}
2. å…§åœ¨é¢¨æ™¯ï¼š${state.mood}
3. é¢å°ç‹€æ…‹ï¼š${state.coping}
4. æ¸´æœ›çµæœï¼š${state.desire}
---------------------------
âœ‰ï¸ ç¥ç¦æ–‡æ¡ˆï¼š
ã€Œ${blessing}ã€
---------------------------
ğŸ“œ èª æ‘¯è¨˜éŒ„æ–¼æ‚¨çš„æ•¸ä½æ²™é¾ ğŸŒ¿
    `.trim();

    try {
        fetch(gasUrl, {
            method: "POST",
            body: JSON.stringify({ result: fullReport }),
            mode: 'no-cors'
        });
    } catch (e) {
        console.log("éœé»˜å‚³é€å¤±æ•—");
    }
}
</script>
</body>
</html>